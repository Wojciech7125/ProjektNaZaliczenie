services:
  android-builder:
    build: .
    container_name: zlecenia-pro-builder
    volumes:
      - .:/app
      - android-cache:/home/builduser/.buildozer
      - gradle-cache:/home/builduser/.gradle
    environment:
      - GRADLE_USER_HOME=/home/builduser/.gradle
      - BUILDOZER_WARN_ON_ROOT=0
      - ANDROID_SDK_ROOT=/home/builduser/.buildozer/android/platform/android-sdk
    working_dir: /app
    stdin_open: true
    tty: true
    command: |
      bash -c "
        echo 'üîß Przygotowywanie ≈õrodowiska budowania...'
        
        # Czekaj na SDK i automatycznie akceptuj licencje
        echo 'Czekam na instalacjƒô SDK...'
        sleep 10
        
        # Automatyczne akceptowanie wszystkich licencji Android SDK
        echo 'Akceptujƒô licencje Android SDK...'
        yes | /home/builduser/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager --licenses 2>/dev/null || true
        yes | /home/builduser/.buildozer/android/platform/android-sdk/tools/bin/sdkmanager --update 2>/dev/null || true
        
        if [ ! -f buildozer.spec ]; then
          echo 'üìù Tworzenie buildozer.spec...'
          buildozer init
        fi
        
        echo 'üöÄ Rozpoczynam budowanie APK...'
        echo 'y' | buildozer android debug
        
        echo '‚úÖ Budowanie zako≈Ñczone!'
        echo 'üì± APK znajduje siƒô w folderze bin/'
        ls -la bin/ || echo 'Folder bin/ nie istnieje'
        find . -name '*.apk' -type f 2>/dev/null || echo 'Nie znaleziono plik√≥w APK'
      "

volumes:
  android-cache:
    driver: local
  gradle-cache:
    driver: local